define(["modules/jquery-mozu","underscore","modules/api","modules/backbone-mozu","modules/models-product"],function(e,t,r,o,a){var u=function(e,o,a){var u=t.map(o,function(e){return"ProductCode eq "+e}).join(" or "),c="";switch(e){case"product":c=r.get("search",{filter:u});break;case"cart":c=r.get("search",{filter:u,pageSize:a})}return c},c=function(e){return!!e},n=require.mozuData("pagecontext");e(document).ready(function(){var r=[];switch(n.pageType){case"product":r.push(require.mozuData("product"));break;case"cart":var d=require.mozuData("cart").items;e.each(d,function(e,t){r.push(t.product)})}e("[data-mz-related-products]").each(function(d,i){i=e(i);for(var p=i.data("mzRelatedProducts"),s=p.attributeId||"tenant~product-crosssell",l=p.template||"modules/product/product-list-carousel",m=p.title,f=p.count||5,h=[],v=o.MozuView.extend({templateName:l}),g=0;g<r.length;g++){var b=r[g];if(b&&b.properties)for(var z=0;z<b.properties.length;z++)if(b.properties[z].attributeFQN==s){var w=t.pluck(b.properties[z].values,"value");h=h.concat(e.grep(w||[],c))}}return h&&h.length?(u(n.pageType,h,f).then(function(e){var t=new a.ProductCollection(e.data),r=new v({model:t,el:i});r.render(),i.prepend("<h3>"+m+"</h3>")}),void 0):(n.isEditMode&&i.html("<b>tbd preview content</b>"),void 0)})})});